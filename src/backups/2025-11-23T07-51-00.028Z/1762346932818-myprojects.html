<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Projects</title>
  <link rel="stylesheet" href="myprojects.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>

  <!-- ===== Top Bar ===== -->
  <header class="topbar">
    <div class="search-container">
      <i class='bx bx-search'></i>
      <input type="text" id="searchInput" placeholder="Search in My Projects..." />
    </div>

    <button class="new-btn">
      <i class='bx bx-plus'></i> New
    </button>
  </header>

  <!-- ===== Main Section ===== -->
  <main class="project-area">
    <h2>My Projects</h2>

    <!-- === New & Recent Boxes === -->
    <div class="top-boxes">
      <!-- New Project -->
      <div class="project-box new-box">
        <div class="icon">
          <i class='bx bx-file-blank'></i>
        </div>
        <p>New Project</p>
      </div>

      <!-- Recent Project -->
      <div class="project-box recent-box">
        <div class="recent-content">
          <i class='bx bx-time-five'></i>
          <div class="recent-icon">
            <p class="file-name">Recent</p>
            <p class="file-date">Modified: Nov 3, 2025</p>
          </div>
        </div>
      </div>
    </div>

    <!-- === File List Section === -->
    <div class="file-list">
      <div class="file-item">
        <i class='bx bxs-file-pdf'></i>
        <span>Project Proposal.pdf</span>
      </div>

      <div class="file-item">
        <i class='bx bxs-file-doc'></i>
        <span>Final Report.docx</span>
      </div>

      <div class="file-item">
        <i class='bx bxs-file'></i>
        <span>Source Code.zip</span>
      </div>
    </div>

    <p id="noResults" class="no-results">No results found</p>
  </main>

  <!-- ===== Upload Modal ===== -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Upload New File</h2>
      <input type="file" id="fileInput" multiple />
      <input type="file" id="folderInput" webkitdirectory style="display:none" />
      <button id="uploadBtn">Upload</button>
    </div>
  </div>

  <!-- ===== Preview Modal ===== -->
  <div id="previewModal" class="modal">
    <div class="modal-content" style="max-width:90%;height:90%;display:flex;flex-direction:column;">
      <span class="close">&times;</span>
      <iframe id="previewFrame" style="width:100%;height:100%;border:none;border-radius:10px;"></iframe>
    </div>
  </div>

  <!-- ===== Script ===== -->
   <script>
document.addEventListener("DOMContentLoaded", () => {
  // === DOM Elements ===
  const modal = document.getElementById("uploadModal");
  const newBtn = document.querySelector(".new-btn");
  const closeBtn = document.querySelector(".close");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const folderInput = document.getElementById("folderInput");
  const fileList = document.querySelector(".file-list");
  const searchInput = document.getElementById("searchInput");
  const noResults = document.getElementById("noResults");
  // === Preview Modal ===
const previewModal = document.getElementById("previewModal");
const previewFrame = document.getElementById("previewFrame");
const previewClose = previewModal.querySelector(".close");

previewClose.addEventListener("click", () => previewModal.style.display = "none");
window.addEventListener("click", (e) => {
  if (e.target === previewModal) previewModal.style.display = "none";
});


  let selectedFiles = []; // store whichever files user picks

  // === Modal Logic ===
  newBtn.addEventListener("click", () => modal.style.display = "flex");
  closeBtn.addEventListener("click", () => modal.style.display = "none");
  window.addEventListener("click", (e) => {
    if (e.target === modal) modal.style.display = "none";
  });

  // === Let user pick files or folder ===
  // when user double clicks inside modal, open file picker
  uploadBtn.insertAdjacentHTML("beforebegin", `
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button id="chooseFileBtn">Choose Files</button>
      <button id="chooseFolderBtn">Choose Folder</button>
    </div>
  `);

  const chooseFileBtn = document.getElementById("chooseFileBtn");
  const chooseFolderBtn = document.getElementById("chooseFolderBtn");

  chooseFileBtn.addEventListener("click", () => fileInput.click());
  chooseFolderBtn.addEventListener("click", () => folderInput.click());

  fileInput.addEventListener("change", () => {
    selectedFiles = Array.from(fileInput.files);
    uploadBtn.disabled = !selectedFiles.length;
  });

  folderInput.addEventListener("change", () => {
    selectedFiles = Array.from(folderInput.files);
    uploadBtn.disabled = !selectedFiles.length;
  });

  // === Upload section ===
  uploadBtn.addEventListener("click", () => {
    if (!selectedFiles.length) return alert("Please select a file or folder to upload!");
 const formData = new FormData();
  let folderName = null;

  // Detect if this is a folder upload
  selectedFiles.forEach(file => {
    if (file.webkitRelativePath) {
      // Example: "MyFolder/file1.txt" â†’ "MyFolder"
      const topFolder = file.webkitRelativePath.split("/")[0];
      folderName = folderName || topFolder;
    }
    formData.append("files", file);
  });

  // If it's a folder upload, include the folder name
  if (folderName) formData.append("folderName", folderName);

    fetch("http://localhost:5000/api/files", {
      method: "POST",
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        console.log("Upload response:", data);
        fileInput.value = "";
        folderInput.value = "";
        modal.style.display = "none";
        loadSystemFiles();
      })
      .catch(err => {
        console.error("Upload failed:", err);
        alert("File upload failed. Try again.");
      });
  });

  uploadBtn.disabled = true;

  // === Search Functionality ===
  let fileItems = fileList.querySelectorAll(".file-item");
  function updateFileItems() {
    fileItems = fileList.querySelectorAll(".file-item");
  }

  searchInput.addEventListener("keyup", () => {
    const searchText = searchInput.value.toLowerCase();
    let found = false;

    fileItems.forEach(item => {
      const fileName = item.querySelector("span").textContent.toLowerCase();
      if (fileName.includes(searchText)) {
        item.style.display = "flex";
        found = true;
      } else item.style.display = "none";
    });

    if (found) noResults.classList.remove("show");
    else noResults.classList.add("show");
  });

  // === Load System Files ===
  function loadSystemFiles() {
    fetch("http://localhost:5000/api/files")
      .then(res => res.json())
      .then(files => {
        fileList.innerHTML = "";
        let foundAny = false;

        files.forEach(file => {
         let iconClass = "bxs-file";
  
  if (file.isFolder) {
    iconClass = "bxs-folder"; // use folder icon
  } else {
    const ext = file.fileName.split(".").pop().toLowerCase();
    if (ext === "pdf") iconClass = "bxs-file-pdf";
    else if (ext === "zip") iconClass = "bxs-file-zip";
    else if (["jpg", "jpeg", "png"].includes(ext)) iconClass = "bxs-file-image";
  }
          const newFile = document.createElement("div");
          newFile.classList.add("file-item");
          newFile.innerHTML = `
         <i class='bx ${iconClass}'></i>
         <span>${file.fileName}</span>
         <button class="delete-btn" data-id="${file._id}">Delete</button>
        `;
        // If it's a file, open it when clicked
newFile.querySelector("span").addEventListener("click", () => {
  if (!file.isFolder) {
    // Show preview modal instead of downloading
    previewFrame.src = `http://localhost:5000/${file.filePath}`;
    previewModal.style.display = "flex";
  } else {
    loadFolderFiles(file.fileName);
  }
});
          fileList.appendChild(newFile);
          foundAny = true;

          // delete button
          newFile.querySelector(".delete-btn").addEventListener("click", () => {
            const id = file._id;
            if (confirm("Are you sure you want to delete this file?")) {
              fetch(`http://localhost:5000/api/files/${id}`, {
  method: "DELETE",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ isFolder: file.isFolder }) // tell backend it's a folder
})

                .then(res => res.json())
                .then(data => {
                  alert(data.message);
                  loadSystemFiles();
                })
                .catch(err => console.error("Delete failed:", err));
            }
          });
        });

        updateFileItems();
        if (!foundAny) noResults.classList.add("show");
        else noResults.classList.remove("show");
      })
      .catch(err => console.error("Failed to load files:", err));
  }

  loadSystemFiles();
});
</script>

</body>
</html>
