<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Projects</title>
  <link rel="stylesheet" href="myprojects.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>

  <!-- ===== Top Bar ===== -->
  <header class="topbar">
    <div class="search-container">
      <i class='bx bx-search'></i>
      <input type="text" id="searchInput" placeholder="Search in My Projects..." />
    </div>

    <button class="new-btn">
      <i class='bx bx-plus'></i> New
    </button>
  </header>

  <!-- ===== Main Section ===== -->
  <main class="project-area">
    <h2>My Projects</h2>

    <div class="top-boxes">
      <div class="project-box new-box">
        <div class="icon">
          <i class='bx bx-file-blank'></i>
        </div>
        <p>New Project</p>
      </div>
      <div class="project-box recent-box">
        <div class="recent-content">
          <i class='bx bx-time-five'></i>
          <div class="recent-icon">
            <p class="file-name">Recent</p>
            <p class="file-date">Modified: Nov 3, 2025</p>
          </div>
        </div>
      </div>
    </div>

    <div class="file-list"></div>
    <p id="noResults" class="no-results">No results found</p>
  </main>

  <!-- ===== Upload Modal ===== -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Upload New File</h2>
      <input type="file" id="fileInput" multiple />
      <input type="file" id="folderInput" webkitdirectory style="display:none" />
      <button id="uploadBtn">Upload</button>
    </div>
  </div>

  <!-- ===== Preview Modal ===== -->
  <div id="previewModal" class="modal">
    <div class="modal-content" style="max-width:90%;height:90%;display:flex;flex-direction:column;">
      <span class="close">&times;</span>
      <iframe id="previewFrame" style="width:100%;height:100%;border:none;border-radius:10px;"></iframe>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("uploadModal");
  const newBtn = document.querySelector(".new-btn");
  const closeBtn = document.querySelector(".close");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const folderInput = document.getElementById("folderInput");
  const fileList = document.querySelector(".file-list");
  const searchInput = document.getElementById("searchInput");
  const noResults = document.getElementById("noResults");
  const previewModal = document.getElementById("previewModal");
  const previewFrame = document.getElementById("previewFrame");
  const previewClose = previewModal.querySelector(".close");

  function getToken() {
    return localStorage.getItem("token") || "";
  }

  function getStudentNameFromToken() {
    const token = getToken();
    if (!token) return "Unknown Student";
    try {
      const payload = JSON.parse(atob(token.split(".")[1]));
      return payload.name || "Unknown Student";
    } catch (e) {
      return "Unknown Student";
    }
  }
  const studentName = getStudentNameFromToken();

  newBtn.addEventListener("click", () => modal.style.display = "flex");
  closeBtn.addEventListener("click", () => modal.style.display = "none");
  window.addEventListener("click", (e) => { if(e.target === modal) modal.style.display = "none"; });

  previewClose.addEventListener("click", () => previewModal.style.display = "none");
  window.addEventListener("click", (e) => { if(e.target === previewModal) previewModal.style.display = "none"; });

  let selectedFiles = [];

  // File/folder chooser buttons
  uploadBtn.insertAdjacentHTML("beforebegin", `
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button id="chooseFileBtn">Choose Files</button>
      <button id="chooseFolderBtn">Choose Folder</button>
    </div>
  `);
  const chooseFileBtn = document.getElementById("chooseFileBtn");
  const chooseFolderBtn = document.getElementById("chooseFolderBtn");
  chooseFileBtn.addEventListener("click", () => fileInput.click());
  chooseFolderBtn.addEventListener("click", () => folderInput.click());

  fileInput.addEventListener("change", () => { selectedFiles = Array.from(fileInput.files); uploadBtn.disabled = !selectedFiles.length; });
  folderInput.addEventListener("change", () => { selectedFiles = Array.from(folderInput.files); uploadBtn.disabled = !selectedFiles.length; });

  // ------------------- Upload Files -------------------
  uploadBtn.addEventListener("click", () => {
    if(!selectedFiles.length) return alert("Please select a file or folder!");

    const formData = new FormData();
    let folderName = null;

    selectedFiles.forEach(file => {
      if(file.webkitRelativePath){
        const topFolder = file.webkitRelativePath.split("/")[0];
        folderName = folderName || topFolder;
      }
      formData.append("files", file);
    });

    if(folderName) formData.append("folderName", folderName);

    fetch("http://localhost:5000/api/files", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + getToken()
      },
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        console.log("Upload response:", data);
        fileInput.value = "";
        folderInput.value = "";
        modal.style.display = "none";
        loadSystemFiles();
      })
      .catch(err => { console.error("Upload failed:", err); alert("Upload failed. Try again."); });
  });
  uploadBtn.disabled = true;

  // ------------------- Load Files -------------------
 function loadSystemFiles() {
  fetch("http://localhost:5000/api/files", {
    headers: { "Authorization": "Bearer " + getToken() }
  })
    .then(res => res.json())
    .then(data => {
      const files = Array.isArray(data) ? data : (data.files || []);
      displayFiles(files);
    })
    .catch(err => console.error("Failed to load files:", err));
}

  function displayFiles(files, folderName = null) {
    fileList.innerHTML = "";
    let foundAny = false;

    if(folderName){
      const backBtn = document.createElement("div");
      backBtn.classList.add("back-btn");
      backBtn.style.cssText = "margin-bottom:10px; cursor:pointer; color:#4a6cf7; display:flex; align-items:center; gap:5px;";
      backBtn.innerHTML = "<i class='bx bx-arrow-back'></i> <span>Back</span>";
      backBtn.addEventListener("click", loadSystemFiles);
      fileList.appendChild(backBtn);

      const title = document.createElement("h3");
      title.style.color = "#333"; title.style.marginBottom = "10px";
      title.textContent = "ðŸ“ Inside: " + folderName;
      fileList.appendChild(title);

      files = files.filter(f => f.folderName === folderName);
    }

    files.forEach(file => {
      let iconClass = file.isFolder ? "bxs-folder" : "bxs-file";
      if(!file.isFolder){
        const ext = file.fileName.split(".").pop().toLowerCase();
        if(ext === "pdf") iconClass = "bxs-file-pdf";
        else if(ext === "zip") iconClass = "bxs-file-zip";
        else if(["jpg","jpeg","png"].includes(ext)) iconClass = "bxs-file-image";
      }

      const newFile = document.createElement("div");
      newFile.classList.add("file-item");
      newFile.innerHTML = `
        <i class='bx ${iconClass}'></i>
        <span>${file.fileName}</span>
        <button class="delete-btn" data-id="${file._id}">Delete</button>
      `;

      newFile.querySelector("span").addEventListener("click", () => {
        if(!file.isFolder){ previewFrame.src = `http://localhost:5000/${file.filePath}`; previewModal.style.display = "flex"; }
        else loadFolderFiles(file.folderName);
      });

      newFile.querySelector(".delete-btn").addEventListener("click", () => {
        if(confirm("Are you sure you want to delete this file?")){
          fetch(`http://localhost:5000/api/files/${file._id}`, {
            method:"DELETE",
            headers: { "Authorization": "Bearer " + getToken() }
          })
            .then(()=> folderName ? loadFolderFiles(folderName) : loadSystemFiles())
            .catch(err=>console.error("Delete failed:", err));
        }
      });

      fileList.appendChild(newFile);
      foundAny = true;
    });

    noResults.classList.toggle("show", !foundAny);
  }
       //loadFolderFiles
  function loadFolderFiles(folderName){
  fetch("http://localhost:5000/api/files", {
    headers: { "Authorization": "Bearer " + getToken() }
  })
    .then(res => res.json())
    .then(data => {
      const files = Array.isArray(data) ? data : (data.files || []);
      displayFiles(files, folderName);
    })
    .catch(err => console.error("Failed to load folder files:", err));
}

  // ------------------- Search -------------------
  searchInput.addEventListener("keyup", () => {
    const query = searchInput.value.toLowerCase();
    const items = document.querySelectorAll(".file-item");
    let foundAny = false;

    items.forEach(item => {
      const text = item.querySelector("span").textContent.toLowerCase();
      if(text.includes(query)){ item.style.display = "flex"; foundAny = true; }
      else item.style.display = "none";
    });

    noResults.classList.toggle("show", !foundAny);
  });

  loadSystemFiles();
});
</script>
<script src="authCheck.js"></script>
</body>
</html>
