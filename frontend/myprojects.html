<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Projects</title>
  <link rel="stylesheet" href="myprojects.css" />
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>

  <nav class="top-nav student-nav">
    <div class="nav-logo">Pamoja Learning Center</div>
    <ul class="nav-links">
      <li><a href="Student.html">Dashboard</a></li>
      <li><a href="myprojects.html" class="active">My Projects</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li><a href="filee.html">Logout</a></li>
    </ul>
  </nav>

  <!-- ===== Top Bar ===== -->
  <header class="topbar">
    <div class="search-container">
      <i class='bx bx-search'></i>
      <input type="text" id="searchInput" placeholder="Search in My Projects..." />
    </div>

  <!-- ===== Share to Tutor Modal ===== -->
  <div id="shareModal" class="modal">
    <div class="modal-content">
      <span class="close share-close">&times;</span>
      <h2>Share Project with Tutor</h2>
      <label for="tutorSelect">Choose Tutor:</label>
      <select id="tutorSelect">
        <option value="">Loading tutors...</option>
      </select>
      <button id="shareConfirmBtn">Share</button>
    </div>
  </div>

    <button class="new-btn">
      <i class='bx bx-plus'></i> New
    </button>
  </header>

  <!-- ===== Main Section ===== -->
  <main class="project-area">
    <h2>My Projects</h2>

    <div class="top-boxes">
      <div class="project-box new-box">
        <div class="icon">
          <i class='bx bx-file-blank'></i>
        </div>
        <p>New Project</p>
      </div>
      <div class="project-box recent-box">
        <div class="recent-content">
          <i class='bx bx-time-five'></i>
          <div class="recent-icon">
            <p class="file-name">Recent</p>
            <p class="file-date">Modified: Nov 3, 2025</p>
          </div>
        </div>
      </div>
    </div>

    <div class="file-list"></div>
    <p id="noResults" class="no-results">No results found</p>
  </main>

  <!-- ===== Upload Modal ===== -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Upload New File</h2>
      <input type="file" id="fileInput" multiple />
      <input type="file" id="folderInput" webkitdirectory style="display:none" />
      <button id="uploadBtn">Upload</button>
    </div>
  </div>

  <!-- ===== Preview Modal ===== -->
  <div id="previewModal" class="modal">
    <div class="modal-content" style="max-width:90%;height:90%;display:flex;flex-direction:column;">
      <span class="close">&times;</span>
      <iframe id="previewFrame" style="width:100%;height:100%;border:none;border-radius:10px;"></iframe>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("uploadModal");
  const newBtn = document.querySelector(".new-btn");
  const closeBtn = document.querySelector(".close");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const folderInput = document.getElementById("folderInput");
  const fileList = document.querySelector(".file-list");
  const searchInput = document.getElementById("searchInput");
  const noResults = document.getElementById("noResults");
  const previewModal = document.getElementById("previewModal");
  const previewFrame = document.getElementById("previewFrame");
  const previewClose = previewModal.querySelector(".close");
  const shareModal = document.getElementById("shareModal");
  const shareClose = shareModal.querySelector(".share-close");
  const tutorSelect = document.getElementById("tutorSelect");
  const shareConfirmBtn = document.getElementById("shareConfirmBtn");
  let currentShareFileId = null;

  function getToken() {
    return localStorage.getItem("token") || "";
  }
  
  async function loadTutorsIntoSelect(){
    tutorSelect.innerHTML = `<option value="">Loading tutors...</option>`;
    try {
      const res = await fetch("/api/tutor/list", {
        headers: { "Authorization": "Bearer " + getToken() }
      });
      const tutors = await res.json();
      tutorSelect.innerHTML = "";
      if (!Array.isArray(tutors) || !tutors.length){
        tutorSelect.innerHTML = `<option value="">No tutors available</option>`;
        return;
      }
      tutors.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t._id;
        opt.textContent = t.username || t.email;
        tutorSelect.appendChild(opt);
      });
    } catch(err){
      console.error("Failed to load tutors", err);
      tutorSelect.innerHTML = `<option value="">Failed to load tutors</option>`;
    }
  }

  shareConfirmBtn.addEventListener("click", async () => {
    const tutorId = tutorSelect.value;
    if (!tutorId){
      return alert("Please choose a tutor");
    }
    if (!currentShareFileId){
      return alert("No file selected to share");
    }
    try {
      const res = await fetch(`/api/files/${currentShareFileId}/share`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + getToken(),
        },
        body: JSON.stringify({ tutorId }),
      });
      const data = await res.json();
      if (!res.ok){
        console.error("Share failed", data);
        return alert(data.message || "Failed to share file");
      }
      alert("File shared with tutor");
      shareModal.style.display = "none";
    } catch(err){
      console.error("Share request failed", err);
      alert("Failed to share file");
    }
  });

  function getStudentNameFromToken() {
    const token = getToken();
    if (!token) return "Unknown Student";
    try {
      const payload = JSON.parse(atob(token.split(".")[1]));
      return payload.name || "Unknown Student";
    } catch (e) {
      return "Unknown Student";
    }
  }
  const studentName = getStudentNameFromToken();

  newBtn.addEventListener("click", () => modal.style.display = "flex");
  closeBtn.addEventListener("click", () => modal.style.display = "none");
  window.addEventListener("click", (e) => { if(e.target === modal) modal.style.display = "none"; });

  previewClose.addEventListener("click", () => previewModal.style.display = "none");
  window.addEventListener("click", (e) => { if(e.target === previewModal) previewModal.style.display = "none"; });

  shareClose.addEventListener("click", () => shareModal.style.display = "none");
  window.addEventListener("click", (e) => { if(e.target === shareModal) shareModal.style.display = "none"; });

  let selectedFiles = [];

  // File/folder chooser buttons
  uploadBtn.insertAdjacentHTML("beforebegin", `
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button id="chooseFileBtn">Choose Files</button>
      <button id="chooseFolderBtn">Choose Folder</button>
    </div>
  `);
  const chooseFileBtn = document.getElementById("chooseFileBtn");
  const chooseFolderBtn = document.getElementById("chooseFolderBtn");
  chooseFileBtn.addEventListener("click", () => fileInput.click());
  chooseFolderBtn.addEventListener("click", () => folderInput.click());

  fileInput.addEventListener("change", () => { selectedFiles = Array.from(fileInput.files); uploadBtn.disabled = !selectedFiles.length; });
  folderInput.addEventListener("change", () => { selectedFiles = Array.from(folderInput.files); uploadBtn.disabled = !selectedFiles.length; });

  // ------------------- Upload Files -------------------
  uploadBtn.addEventListener("click", () => {
    if(!selectedFiles.length) return alert("Please select a file or folder!");

    const formData = new FormData();
    let folderName = null;

    selectedFiles.forEach(file => {
      if(file.webkitRelativePath){
        const topFolder = file.webkitRelativePath.split("/")[0];
        folderName = folderName || topFolder;
      }
      formData.append("files", file);
    });

    if(folderName) formData.append("folderName", folderName);

    fetch("/api/files", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + getToken()
      },
      body: formData
    })
      .then(res => res.json())
      .then(data => {
        console.log("Upload response:", data);
        fileInput.value = "";
        folderInput.value = "";
        modal.style.display = "none";
        loadSystemFiles();
      })
      .catch(err => { console.error("Upload failed:", err); alert("Upload failed. Try again."); });
  });
  uploadBtn.disabled = true;

  // ------------------- Load Files -------------------
 function loadSystemFiles() {
  fetch("/api/files", {
    headers: { "Authorization": "Bearer " + getToken() }
  })
    .then(res => res.json())
    .then(data => {
      const files = Array.isArray(data) ? data : (data.files || []);
      displayFiles(files);
    })
    .catch(err => console.error("Failed to load files:", err));
}

  function displayFiles(files, folderName = null) {
    fileList.innerHTML = "";
    let foundAny = false;

    if(folderName){
      const backBtn = document.createElement("div");
      backBtn.classList.add("back-btn");
      backBtn.style.cssText = "margin-bottom:10px; cursor:pointer; color:#4a6cf7; display:flex; align-items:center; gap:5px;";
      backBtn.innerHTML = "<i class='bx bx-arrow-back'></i> <span>Back</span>";
      backBtn.addEventListener("click", loadSystemFiles);
      fileList.appendChild(backBtn);

      const title = document.createElement("h3");
      title.style.color = "#333"; title.style.marginBottom = "10px";
      title.textContent = "ðŸ“ Inside: " + folderName;
      fileList.appendChild(title);

      files = files.filter(f => f.folderName === folderName);
    }

    files.forEach(file => {
      let iconClass = file.isFolder ? "bxs-folder" : "bxs-file";
      if(!file.isFolder){
        const ext = file.fileName.split(".").pop().toLowerCase();
        if(ext === "pdf") iconClass = "bxs-file-pdf";
        else if(ext === "zip") iconClass = "bxs-file-zip";
        else if(["jpg","jpeg","png"].includes(ext)) iconClass = "bxs-file-image";
      }

      const newFile = document.createElement("div");
      newFile.classList.add("file-item");
      newFile.innerHTML = `
        <i class='bx ${iconClass}'></i>
        <span>
          ${file.fileName}
          ${file.feedback ? `<br><small style="color:#6b7280;">Feedback: ${file.feedback}</small>` : ""}
        </span>
        <div class="file-actions" style="display:flex; gap:8px; margin-left:auto;">
          <button class="download-btn" style="background:#7ec8ff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Download</button>
          <button class="share-btn" style="background:#c9a5ff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">Share Tutor</button>
          <button class="delete-btn" data-id="${file._id}" style="background:#ff6b6b; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; color:#fff;">Delete</button>
        </div>
      `;

      newFile.querySelector("span").addEventListener("click", () => {
        if(!file.isFolder){ previewFrame.src = `/${file.filePath}`; previewModal.style.display = "flex"; }
        else loadFolderFiles(file.folderName);
      });

      // Download action
      newFile.querySelector(".download-btn").addEventListener("click", (e) => {
        e.stopPropagation();
        if (file.isFolder) return; // simple behavior: only download files
        window.open(`/${file.filePath}`, "_blank");
      });

      // Share to tutor action
      newFile.querySelector(".share-btn").addEventListener("click", async (e) => {
        e.stopPropagation();
        currentShareFileId = file._id;
        await loadTutorsIntoSelect();
        shareModal.style.display = "flex";
      });

      // Delete action
      newFile.querySelector(".delete-btn").addEventListener("click", (e) => {
        e.stopPropagation();
        if(confirm("Are you sure you want to delete this file?")){
          fetch(`/api/files/${file._id}`, {
            method:"DELETE",
            headers: { "Authorization": "Bearer " + getToken() }
          })
            .then(()=> folderName ? loadFolderFiles(folderName) : loadSystemFiles())
            .catch(err=>console.error("Delete failed:", err));
        }
      });

      fileList.appendChild(newFile);
      foundAny = true;
    });

    noResults.classList.toggle("show", !foundAny);
  }
       //loadFolderFiles
  function loadFolderFiles(folderName){
  fetch("/api/files", {
    headers: { "Authorization": "Bearer " + getToken() }
  })
    .then(res => res.json())
    .then(data => {
      const files = Array.isArray(data) ? data : (data.files || []);
      displayFiles(files, folderName);
    })
    .catch(err => console.error("Failed to load folder files:", err));
}

  // ------------------- Search -------------------
  searchInput.addEventListener("keyup", () => {
    const query = searchInput.value.toLowerCase();
    const items = document.querySelectorAll(".file-item");
    let foundAny = false;

    items.forEach(item => {
      const text = item.querySelector("span").textContent.toLowerCase();
      if(text.includes(query)){ item.style.display = "flex"; foundAny = true; }
      else item.style.display = "none";
    });

    noResults.classList.toggle("show", !foundAny);
  });

  loadSystemFiles();
});
</script>
<script src="authCheck.js"></script>
</body>
</html>
